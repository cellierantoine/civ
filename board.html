<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <title>Civ</title>
        <script src="//cdn.jsdelivr.net/phaser/2.2.2/phaser.min.js"></script>
        <style type="text/css">
            body {
                margin: 0;
            }
        </style>
    </head>
    <body>
        <script src="tile.js"></script>
        <script src="event.js"></script>
        <script src="resource.js"></script>
        <script src="construction.js"></script>
        <script src="sideMenuButtons.js"></script>
        <script src="player.js"></script>
        <script type="text/javascript">
            var TILE_SIZE = 32;
            var TILE_ASPECT = 1;
            var LEVEL_SIZE = 21;
            var TOP_BAR_SIZE = 64;
            var SIDE_BAR_SIZE = 200;

            var RES_FLUX = 1;


            var game = new Phaser.Game(1072, 736, Phaser.AUTO, '', { preload: preload, create: create, update: update });


            function preload() {
                //ui
                game.load.image('background', 'assets/ui/background.png');
                game.load.image('selector', 'assets/ui/selector.png');
                game.load.image('food', 'assets/ui/food.png');
                game.load.image('stone', 'assets/ui/rock.png');
                game.load.image('citizen', 'assets/ui/citizen.png');
                game.load.image('wood', 'assets/ui/wood.png');
                game.load.image('information', 'assets/info.png')
                game.load.image('gold', 'assets/ui/gold.png');
                game.load.image('previouspage', 'assets/ui/previouspage.png');
                game.load.image('nextpage', 'assets/ui/nextpage.png');


                //Tiles
                game.load.image('grass1', 'assets/terrain/grass1.png');
                game.load.image('grass2', 'assets/terrain/grass2.png');
                game.load.image('grass3', 'assets/terrain/grass3.png');
                game.load.image('water', 'assets/terrain/water.png');

                //Building
                game.load.image('house', 'assets/building/house.png');
                game.load.image('farm', 'assets/building/farm.png');
                game.load.image('mine', 'assets/building/mine.png');
                game.load.image('woodcutter', 'assets/building/woodcutter.png');
                game.load.image('dyke', 'assets/building/dyke.png');
                game.load.image('observatory', 'assets/building/observatory.png');
                game.load.image('fishership', 'assets/building/fishership.png');
                game.load.image('market', 'assets/building/market.png');
                game.load.image('keep', 'assets/building/keep.png');

                game.load.image('food+', 'assets/menu/food+.png');
                game.load.image('food-', 'assets/menu/food-.png');
                game.load.image('wood+', 'assets/menu/wood+.png');
                game.load.image('wood-', 'assets/menu/wood-.png');
                game.load.image('rock+', 'assets/menu/rock+.png');
                game.load.image('rock-', 'assets/menu/rock-.png');

                game.load.image('goldF+', 'assets/menu/goldF+.png');
                game.load.image('goldF-', 'assets/menu/goldF-.png');
                game.load.image('goldW+', 'assets/menu/goldW+.png');
                game.load.image('goldW-', 'assets/menu/goldW-.png');
                game.load.image('goldR+', 'assets/menu/goldR+.png');
                game.load.image('goldR-', 'assets/menu/goldR-.png');

                game.load.image('worker+', 'assets/worker+.png');
                game.load.image('worker-', 'assets/worker-.png');
                game.load.image('bomb', 'assets/bomb.png');

                game.load.image('pickaxe', "assets/pickaxe.png");
                game.load.image('axe', "assets/axe.png");

                game.load.image('sky', 'assets/moonsky.png');

                //Wonder
                game.load.image('wonder',"assets/wonder/wonder.png");
                game.load.image('wonder2',"assets/wonder/wonder2.png");
                game.load.image('wonder3',"assets/wonder/wonder3.png");
                game.load.image('wonder4',"assets/wonder/wonder4.png");

                //Resources
                game.load.image('tree', 'assets/resources/tree.png');
                game.load.image('rock', 'assets/resources/rock.png');
            }


            //UI
            var ground = [];
            var start;
            var resourceTime;
            var selector;
            var disaster = null;
            var eraNumber = 0;

            var x;
            var y;

            var displayText;

            var menu = [[701,108],[777,108],[701,183],[777,183],[701,259],[777,259],[701,334],[777,334],[701,410],[777,410],[701,485],[777,485]];
            var buttons = [];

            var player = new Player();

            var displayGold;
            var displayFood;
            var displayRock;
            var displayWood;
            var displayCitizen;

            //Resource system
            var inputFoodFarm = 0;
            var inputFoodFish = 0;
            var inputWood = 0;
            var inputRock = 0;
            var inputGold = 0;

            //Resource Market System
            var tradeRock = 0;
            var tradeWood = 0;
            var tradeFood = 0;

            var tradeRouteFoodIn = [];
            var tradeRouteWoodIn = [];
            var tradeRouteRockIn = [];
            var tradeRouteFoodOut = [];
            var tradeRouteWoodOut = [];
            var tradeRouteRockOut = [];

            //Starvation and citizen system
			var starvation = false;
			var citizenDecay;
			var citizenGrow;
			var citizenStack = [];


            function create() {
                //SPRITE
                game.add.sprite(0, 0, 'background');

                game.add.sprite(25, 16, 'food');
                game.add.sprite(175, 16, 'stone');
                game.add.sprite(325, 16, 'wood');
                game.add.sprite(475, 16, 'citizen');
                game.add.sprite(625, 16, 'gold');

                displayFood = game.add.text(65, 20, player.food.toString(), { font: "20px Arial", fill: "#000000", align: "center" });
                displayRock = game.add.text(215, 20, player.rock.toString(), { font: "20px Arial", fill: "#000000", align: "center" });
                displayWood = game.add.text(365, 20, player.wood.toString(), { font: "20px Arial", fill: "#000000", align: "center" });
                displayCitizen = game.add.text(515, 20, player.inhabitant + "/" + player.citizen, { font: "20px Arial", fill: "#000000", align: "center" });
                displayGold = game.add.text(665, 20, player.gold.toString(), { font: "20px Arial", fill: "#000000", align: "center" });

                mapLake(ground);


                //SELECTOR
                selector = new Selector();

                //LISTENERS
                document.addEventListener("click", function(event){ click(event, ground, selector); });
                document.addEventListener("mousemove", hover);

                //TIME
                start = game.time.now;
                resourceTime = game.time.now;

                //BUTTONS
                for(let i = 0; i<menu.length; i++){
                    buttons.push(new Button(menu[i][0], menu[i][1]));
                }

                displayText = game.add.text(700, 600, "", {font: "12px Arial", fill: "#000000", align: "center"});

                game.time.events.repeat(Phaser.Timer.SECOND * 240, 5, era);
            }

            function update() {
                let i;

                if(game.time.now > start+5000){
                    //flood(ground);
                    start = game.time.now;
                }

                if(x>692 && x<853 && y>99 && y<561){
                    selector.hoverSideMenu(x, y);
                }
                
                if(game.time.now > resourceTime+1000){
                    player.wood += inputWood + tradeWood;
                    player.rock += inputRock + tradeRock;
                    player.gold += inputGold;
                    if(player.food >0){
                        let x = (player.citizen-1)*0.5;
                        if(player.citizen == 0){
                            x = 0;
                        }
                        if(droughtFarm){
                            player.food += inputFoodFish - x + tradeFood;
                        }else{
                            player.food += inputFoodFarm + inputFoodFish - x + tradeFood;
                        }
                    }
                    
                    if(player.food <= 0){
                        player.food = 0;
                        for(i = 0; i<tradeRouteFoodOut.length; i++){
                            tradeRouteFoodOut[i].removeTradeRouteOut('food');
                        }
                    }
                    if(player.wood <= 0){
                        player.wood = 0;
                        for(i = 0; i<tradeRouteWoodOut.length; i++){
                            tradeRouteWoodOut[i].removeTradeRouteOut('wood');
                        }
                    }
                    if(player.rock <= 0){
                        player.rock = 0;
                        for(i = 0; i<tradeRouteRockOut.length; i++){
                            tradeRouteRockOut[i].removeTradeRouteOut('rock');
                        }
                    }
                    if(player.gold <= 0){
                        player.gold = 0;
                        for(i = 0; i<tradeRouteFoodIn.length; i++){
                            tradeRouteFoodIn[i].removeTradeRouteIn('food');
                        }
                        for(i = 0; i<tradeRouteWoodIn.length; i++){
                            tradeRouteWoodIn[i].removeTradeRouteIn('wood');
                        }
                        for(i = 0; i<tradeRouteRockIn.length; i++){
                            tradeRouteRockIn[i].removeTradeRouteIn('rock');
                        }
                        
                    }
                    resource();
                    resourceTime = game.time.now;
                }
                
                

                if(player.food <= 0 && starvation == false){
                    starvation = true;
					citizenDecay = game.time.now;
				}else if(player.food > 0 && starvation == true){
					starvation = false;
					citizenGrow = game.time.now;
				}
				
				if(starvation == true && game.time.now > citizenDecay + 5000){
					if(player.citizen>1){
						player.citizen --;
						player.inhabitant --;
						if(player.inhabitant<0){
                            citizenStack[citizenStack.length-1].removeWorker();
                        }
					}
					citizenDecay = game.time.now;
				}
				if(player.citizenCap > player.citizen && starvation == false && game.time.now > citizenGrow + 5000){
                    player.inhabitant ++;
                    player.citizen ++;
				    citizenGrow = game.time.now;
                }

                if(player.citizenCap < player.citizen){
				    let delta = player.citizen - player.citizenCap;
                    player.citizen = player.citizenCap;
                    for(let i=0; i<delta; i++){
                        player.inhabitant --;
                        if(player.inhabitant<0){
                            citizenStack[citizenStack.length-1].removeWorker();
                        }
                    }
                }
            }

            function click(event, ground, selector){
                if(event.pageX < 872- SIDE_BAR_SIZE && event.pageY > TOP_BAR_SIZE){
                    selector.moveSelector(event, ground);
                    selector.displaySideMenu(selector.tileSelected.terrainType, selector.tileSelected.building, selector.tileSelected.resource);
                }else if(selector.tileSelected != null && buttons[0].act!= null
                && event.pageX > buttons[0].x && event.pageX < buttons[0].x+68
                && event.pageY > buttons[0].y && event.pageY < buttons[0].y +68){
					buttons[0].act.apply(selector.tileSelected);
                }else if(selector.tileSelected != null && buttons[1].act!= null
                && event.pageX > buttons[1].x && event.pageX < buttons[1].x+68
                && event.pageY > buttons[1].y && event.pageY < buttons[1].y +68){
                    buttons[1].act.apply(selector.tileSelected);
                }else if(selector.tileSelected != null && buttons[2].act!= null
                && event.pageX > buttons[2].x && event.pageX < buttons[2].x+68
                && event.pageY > buttons[2].y && event.pageY < buttons[2].y +68){
                    buttons[2].act.apply(selector.tileSelected);
                }else if(selector.tileSelected != null && buttons[3].act!= null
                    && event.pageX > buttons[3].x && event.pageX < buttons[3].x+68
                    && event.pageY > buttons[3].y && event.pageY < buttons[3].y +68){
                    buttons[3].act.apply(selector.tileSelected);
                }else if(selector.tileSelected != null && buttons[4].act!= null
                    && event.pageX > buttons[4].x && event.pageX < buttons[4].x+68
                    && event.pageY > buttons[4].y && event.pageY < buttons[4].y +68){
                    buttons[4].act.apply(selector.tileSelected);
                }else if(selector.tileSelected != null && buttons[5].act!= null
                    && event.pageX > buttons[5].x && event.pageX < buttons[5].x+68
                    && event.pageY > buttons[5].y && event.pageY < buttons[5].y +68){
                    buttons[5].act.apply(selector.tileSelected);
                }else if(selector.tileSelected != null && buttons[6].act!= null
                    && event.pageX > buttons[6].x && event.pageX < buttons[6].x+68
                    && event.pageY > buttons[6].y && event.pageY < buttons[6].y +68){
                    buttons[6].act.apply(selector.tileSelected);
                }else if(selector.tileSelected != null && buttons[7].act!= null
                    && event.pageX > buttons[7].x && event.pageX < buttons[7].x+68
                    && event.pageY > buttons[7].y && event.pageY < buttons[7].y +68){
                    buttons[7].act.apply(selector.tileSelected);
                }else if(selector.tileSelected != null && buttons[8].act!= null
                    && event.pageX > buttons[8].x && event.pageX < buttons[8].x+68
                    && event.pageY > buttons[8].y && event.pageY < buttons[8].y +68){
                    buttons[8].act.apply(selector.tileSelected);
                }else if(selector.tileSelected != null && buttons[9].act!= null
                    && event.pageX > buttons[9].x && event.pageX < buttons[9].x+68
                    && event.pageY > buttons[9].y && event.pageY < buttons[9].y +68){
                    buttons[9].act.apply(selector.tileSelected);
                }else if(selector.tileSelected != null && buttons[10].act!= null
                    && event.pageX > buttons[10].x && event.pageX < buttons[10].x+68
                    && event.pageY > buttons[10].y && event.pageY < buttons[10].y +68){
                    buttons[10].act.apply(selector.tileSelected);
                }else if(selector.tileSelected != null && buttons[11].act!= null
                    && event.pageX > buttons[11].x && event.pageX < buttons[11].x+68
                    && event.pageY > buttons[11].y && event.pageY < buttons[11].y +68){
                    buttons[11].act.apply(selector.tileSelected);
                }
            }

            function hover(event){
                x = event.pageX;
                y = event.pageY;
            }

            function resource(){
                let style = { font: "20px Arial", fill: "#000000", align: "center" };

                displayFood.destroy();
                displayRock.destroy();
                displayWood.destroy();
                displayCitizen.destroy();
                displayGold.destroy();

                displayFood = game.add.text(65, 20, player.food.toString(), style);
                displayRock = game.add.text(215, 20, player.rock.toString(), style);
                displayWood = game.add.text(365, 20, player.wood.toString(), style);
                displayCitizen = game.add.text(515, 20, player.inhabitant + "/" + player.citizen, style);
                displayGold = game.add.text(665, 20, player.gold.toString(), style);
            }
            


        </script>

    </body>
</html>

